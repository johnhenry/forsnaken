<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <script src="//code.jquery.com/jquery-1.12.4.js"></script>
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      background: black;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    canvas {
      border: 1px solid white;
    }
    </style>
  </head>
  <body>
  <canvas width="800" height="400" id="game"></canvas>
  <script>
  const WARNING = `WARNING: PHOTOSENSITIVITY/EPILEPSY SEIZURES

  A very small percentage of individuals may experience epileptic seizures or blackouts when exposed to certain light patterns or flashing lights. Exposure to certain patterns or backgrounds on a television screen or when playing video games may trigger epileptic seizures or blackouts in these individuals. These conditions may trigger previously undetected epileptic symptoms or seizures in persons who have no history of prior seizures or epilepsy. If you, or anyone in your family has an epileptic condition or has had seizures of any kind, consult your physician before playing.

  IMMEDIATELY DISCONTINUE use and consult your physician before resuming gameplay. If you or your child experience any of the following health problems or symptoms:

  - Dizziness
  - Altered vision
  - Eye or muscle twitches
  - Loss of awareness
  - Disorientation
  - Seizures or
  - Any involuntary movement or convulsion`;

  // if(!confirm(WARNING)){
  //   window.location = 'https://www.google.com';
  // };
  </script>
  <script type="module">
    import Apple from './apple.mjs';
    import Snake from './snake.mjs';
    import KeyBrain, { arrows, wasd, antiArrows, antiWasd } from './keybrain.mjs';
    import collisions from './collisions.mjs';
    import collide2d from './collide2d.mjs';

    const canvas = document.getElementById('game');
    const zoom = 8; // Must be a divisor of width and length; there exists n, m s.t. n * zoom === length && m * zoom = width;
    const gameWidth = canvas.width/zoom;
    const gameHeight = canvas.height/zoom;
    const context = canvas.getContext('2d');

    const drawFactory = (context, width, height, zoom) => (...things)=>{
      // draw each apple and snake
      context.clearRect(0, 0, canvas.width, canvas.height);
      for(const {color, cells} of things){
        for(const cell of cells){
          context.fillStyle = color;
          context.fillRect(cell.x*zoom, cell.y*zoom, zoom, zoom);
        }
      }
    }
    const draw = drawFactory(context, canvas.width, canvas.height, zoom);

    const playerConfig = [
      {x: 0,                 y: 0,                velocity:+1,  horizontal:true,    brain: new KeyBrain(arrows),      color:'green' },
      {x: gameWidth - 1,     y: 0,                velocity:+1,  horizontal:false,   brain: new KeyBrain(wasd),        color:'blue'  },
      {x: gameWidth - 1,     y: gameHeight - 1,   velocity:-1,   horizontal:true,   brain: new KeyBrain(antiWasd),    color:'purple'},
      {x: 0,                 y: gameHeight - 1,   velocity:-1,  horizontal:false,   brain: new KeyBrain(antiArrows),  color:'yellow'},
    ];
    const AppleEatenEvent = class extends Event {
      constructor(direction){
        super('apple eaten');
        this.direction = direction;
      }
    }
    // State
    const gameFactory = ({appleNum=1, playerConfig=[], gameWidth=400, gameHeight=400}) => {
      const snakes = playerConfig.map(config=>new Snake(config));
      const apples = [];
      for(let i = 0; i < appleNum; i++){
        apples.push(new Apple({xrange:[0, gameWidth], yrange:[0, gameHeight] }));
      }
      return () => {
        const events = [];
        // check for collision between each snake's head and each apple
        for (const [head, apple] of collisions(collide2d, snakes.map(({head})=>head), apples)){
          // if collision happens (snake eats apple)
          const snake = snakes.find((snake=>collide2d(head, snake.head)));
          snake.grow(apple.value)
          apple.spawn(...snakes.map(({cells}) =>cells ).flat());
          // grow snake
          // shanke screen based on snake direction
          const { direction } = snake;
          const eatEvent = new AppleEatenEvent(direction);
          events.push(eatEvent);
        }

        // check for collision between each snake's head and each other snake
        for (const [head, part] of collisions(collide2d, snakes.map(({head})=>head), snakes.map(({cells})=>cells).flat())){
          let snake = snakes.filter(_=>_).find((snake=>collide2d(head, snake.head)));
          const otherSnake = snakes.filter(_=>_).flat().find((snake=>snake.head===part));
          if(otherSnake){
            snake = Math.random() < 0.5 ? snake : otherSnake;              
          }
          snake.disable(); // destory old snake (remove listeners)
        }

        // revive any dead snakes
        for(const index in snakes){
          if(!snakes[index].enabled){
            snakes[index] = new Snake(playerConfig[index]); // create new snake
          }
        }
        // revive any dead snakes
        for(const index in snakes){
          if(!snakes[index].enabled){
            snakes[index] = new Snake(playerConfig[index]); // create new snake
          }
        }
        // move each snake
        for(const snake of snakes){
          snake.move({width: gameWidth, height: gameHeight})
        }
        return { status:'render', entities:[...apples, ...snakes], events:[...events] };
      }
    }


    const game = gameFactory({appleNum:32, playerConfig, gameWidth, gameHeight});
    // game loop
    const FPS = 10;// Set to divisors of 60: 60, 30, 20, 15, 12, 10, 6, 5, 4, 3, 2, 1
    let count = 0;
    const loop = () => {
      requestAnimationFrame(loop);
      // slow game loop to FPS fps instead of 60 (60/FPS = 4)
      if (++count < 60/FPS) {
        return;
      }
      count = 0;
      const {status, entities, events, error} = game();
      switch(status){
        case 'render':
          draw(...entities);
          // apply effects
          const appleEatenEvents = events.filter(event => event instanceof AppleEatenEvent)
          for(const { direction } of appleEatenEvents){
            $("#game").effect("shake", { direction });
          }
        case 'error':
        default:
        break;
      }
    };

  // start the game
  const start = ()=>{
    requestAnimationFrame(loop);
  }
  start();
  </script>
  </body>
</html>
