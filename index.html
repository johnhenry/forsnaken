<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <script src="//code.jquery.com/jquery-1.12.4.js"></script>
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      background: black;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    canvas {
      border: 1px solid white;
    }
    </style>
  </head>
  <body>
  <canvas width="400" height="400" id="game"></canvas>
  <script>
  const WARNING = `WARNING: PHOTOSENSITIVITY/EPILEPSY SEIZURES

  A very small percentage of individuals may experience epileptic seizures or blackouts when exposed to certain light patterns or flashing lights. Exposure to certain patterns or backgrounds on a television screen or when playing video games may trigger epileptic seizures or blackouts in these individuals. These conditions may trigger previously undetected epileptic symptoms or seizures in persons who have no history of prior seizures or epilepsy. If you, or anyone in your family has an epileptic condition or has had seizures of any kind, consult your physician before playing.

  IMMEDIATELY DISCONTINUE use and consult your physician before resuming gameplay. If you or your child experience any of the following health problems or symptoms:

  - Dizziness
  - Altered vision
  - Eye or muscle twitches
  - Loss of awareness
  - Disorientation
  - Seizures or
  - Any involuntary movement or convulsion`;

  // if(!confirm(WARNING)){
  //   window.location = 'https://www.google.com';
  // };
  </script>
  <script type="module">
    
    import Apple from './apple.mjs';
    import Snake from './snake.mjs';
    import KeyBrain from './keybrain.mjs';
    import collisions from './collisions.mjs';
    import { arrows, wasd } from './keyboardConfigs.js';

    const collide = (subject, {x, y}) => subject.x===x && subject.y===y;
    const FPS = 12;// Set to divisors of 60: 60, 30, 20, 15, 12, 10, 6, 5, 4, 3, 2, 1
    let count = 0;
    const canvas = document.getElementById('game');
    const { width, height } =  canvas;
    const context = canvas.getContext('2d');
    const unit = 16;
    const velocity = 16;
    const size = 2;
    const brains = [new KeyBrain(arrows), new KeyBrain(wasd)];
    const playerConfig = [
      {x:0,   y:0,   velocity:+1*velocity, horizontal:true,  brain:brains[0], color:'green' },
      {x:384, y:0,   velocity:+1*velocity, horizontal:false, brain:brains[0], color:'blue'  },
      {x:384, y:384, velocity:-1*velocity, horizontal:true,  brain:brains[1], color:'purple'},
      {x:0,   y:384, velocity:-1*velocity, horizontal:false, brain:brains[1], color:'yellow'},
    ];
    const state = {
      status: 'playing',
      snakes: playerConfig.map(config=>new Snake(config)),
      apples: [new Apple({ unit, width, height }), new Apple({ unit, width, height })]
    };

    const drawSquare = (context, fillStyle, {x, y}, unit)=>{
      context.fillStyle = fillStyle;
      context.fillRect(x, y, unit, unit);
    }
    // game loop
    const loop = () => {
      requestAnimationFrame(loop);
      // slow game loop to FPS fps instead of 60 (60/FPS = 4)
      if (++count < 60/FPS) {
        return;
      }
      count = 0;
      context.clearRect(0, 0, width, height);
      switch(state.status){
        case 'playing':
        default:
          // draw each apple and snake
          for(const {color, cells} of [...state.apples, ...state.snakes]){
            for(const cell of cells){
              drawSquare(context, color, cell, unit);
            }
          }
          // check for collision between each snake's head and each apple
          for (const [head, apple] of collisions(collide, state.snakes.map(({head})=>head), state.apples)){
            // if collision happens (snake eats apple)
            const snake = state.snakes.find((snake=>collide(head, snake.head)));
            const index = state.apples.indexOf(apple);
            snake.grow(apple.value)
            state.apples[index] = new Apple({ unit, width, height });
            // grow snake
            // shanke screen based on snake direction
            const { direction } = snake;
            $("#game").effect("shake", { direction });
            break;
          }

          // check for collision between each snake's head and each other snake
          for (const [head, part] of collisions(collide, state.snakes.map(({head})=>head), state.snakes.map(({cells})=>cells).flat())){
            let snake = state.snakes.filter(_=>_).find((snake=>collide(head, snake.head)));
            const otherSnake = state.snakes.filter(_=>_).flat().find((snake=>snake.head===part));
            if(otherSnake){
              snake = Math.random() < 0.5 ? snake : otherSnake;              
            }
            snake.destroy(); // destory old snake (remove listeners)
            state.snakes[state.snakes.indexOf(snake)] = null;
          }

          // revive any dead snakes
          for(const index in state.snakes){
            if(!state.snakes[index]){
              state.snakes[index] = new Snake(playerConfig[index]); // create new snake
            }
          }
          // move each snake
          for(const snake of state.snakes){
            snake.move({width, height})
          }
      }
    };

  // start the game
  const start = ()=>{
    requestAnimationFrame(loop);
  }
  start();
  </script>
  </body>
</html>